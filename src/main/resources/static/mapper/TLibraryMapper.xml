<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.uos.comp6239backend.mapper.TLibraryMapper">

  <!--根据读者ID展示其收藏的所有的书和剧本作者，阅读进度-->
<select id="selectReaderStoryDetail" parameterType="java.util.Map" resultType="com.uos.comp6239backend.tdata.entity.TStoryDetail">
    SELECT DISTINCT
        s.story_id,
        s.story_name,
        s.story_description,
        s.story_trends,
        s.story_cover_url,
        u.user_id AS author_id,
        u.username AS author_name,
        rsh.current_progress
    FROM
        t_story s
    JOIN
        t_users u ON s.author_id = u.user_id
    JOIN
        t_library tl ON tl.story_id = s.story_id AND tl.is_used = 1
    JOIN
        t_reader_story_history rsh ON rsh.story_id = s.story_id
    WHERE
        rsh.reader_id = #{readerId,jdbcType=INTEGER}
        AND rsh.is_used = 1
</select>

<!--    主页查询所有故事的基本信息-->
    <select id="selectAllStoryDetail" parameterType="java.util.Map" resultType="com.uos.comp6239backend.tdata.entity.TStoryDetail">
    SELECT DISTINCT
    s.*
    FROM
    t_story s
    where is_used = 1
    </select>


  <!--根据读者ID展示图书馆-->
  <select id="tLibraryList" resultType="com.uos.comp6239backend.tdata.entity.TStorys">
    select ts.*
    from t_story ts,t_library tl,t_users tu
    where
    reader_id = #{readerId,jdbcType=INTEGER} and
    ts.is_used=1 and tl.is_used=1 and tu.is_used=1 and
    tl.story_id = ts.story_id and tu.user_id = tl.reader_id

  </select>

  <!--根据读者ID和剧本ID和剧本作者ID展示剧本作者，阅读进度-->
  <select id="tLibraryListReaderStoryForUiState" resultType="com.uos.comp6239backend.tdata.entity.TStorysForUiState">
    select tu.username,trsh.current_progress,tu.user_id，trsh.story_id
    from t_users tu,t_reader_story_history trsh
--      t_reading_path trp,t_reading_path_item trpi,
    where
    tu.user_id = #{readerId,jdbcType=INTEGER} and trsh.story_id = #{storyId,jdbcType=INTEGER}
    and trsh.reader_id = #{readerId,jdbcType=INTEGER} and
    ts.is_used=1 and trsh.is_used=1

  </select>

<!--  收藏某个剧本-->
  <insert id="tLibraryInsert" parameterType="java.util.Map">
    insert into t_library
    <trim prefix="(" suffix=")" suffixOverrides=",">
      <if test="readerId != null">
        reader_id,
      </if>
      <if test="storyId != null">
        story_id,
      </if>
      <if test="isUsed != null">
        is_used,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides=",">
      <if test="readerId != null">
        #{readerId,jdbcType=INTEGER},
      </if>
      <if test="storyId != null">
        #{storyId,jdbcType=INTEGER},
      </if>
      <if test="isUsed != null">
        #{isUsed,jdbcType=INTEGER},
      </if>
    </trim>
  </insert>

<!--  取消收藏某个剧本-->
  <update id="tLibraryDel"  parameterType="java.util.Map">
    update t_library set is_used = 0
    where reader_id = #{readerId,jdbcType=INTEGER} and story_id = #{storyId,jdbcType=INTEGER}
  </update>


</mapper>
